<div class="odontogram-container">
  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-left">
      <button type="button" class="btn-icon" (click)="toggleNumbers()" [title]="showNumbers() ? 'Ocultar numeración' : 'Mostrar numeración'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <text x="12" y="16" text-anchor="middle" font-size="12" font-weight="bold">123</text>
        </svg>
      </button>
      
      <!-- Botón para prótesis total -->
      <button 
        type="button" 
        class="btn-icon btn-arch-selector" 
        *ngIf="activeMarker === 'total-prosthesis-done' || activeMarker === 'total-prosthesis-planned'"
        (click)="toggleArchSelector()"
        [class.active]="showArchSelector()"
        title="Seleccionar maxilar completo">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
      </button>

      <!-- Botón para PPR -->
      <button 
        type="button" 
        class="btn-icon btn-range-selector" 
        *ngIf="activeMarker === 'ppr-done' || activeMarker === 'ppr-planned'"
        (click)="startRangeSelection()"
        [class.active]="rangeSelectionMode()"
        [title]="rangeSelectionMode() ? 'Seleccione dientes de inicio y fin' : 'Seleccionar rango de dientes'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M5 12l4-4M5 12l4 4M19 12l-4-4M19 12l-4 4"/>
        </svg>
      </button>

      <!-- Cancelar selección de rango -->
      <button 
        type="button" 
        class="btn-icon btn-cancel" 
        *ngIf="rangeSelectionMode()"
        (click)="cancelRangeSelection()"
        title="Cancelar selección de rango">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="toolbar-center">
      <span class="instruction" *ngIf="!rangeSelectionMode() && !showArchSelector()">Selecciona una marca y haz clic en las superficies del diente</span>
      <span class="instruction instruction-range" *ngIf="rangeSelectionMode() && rangeStart() === null">Seleccione el diente de inicio del rango</span>
      <span class="instruction instruction-range" *ngIf="rangeSelectionMode() && rangeStart() !== null && rangeEnd() === null">Diente inicio: {{ rangeStart() }}. Ahora seleccione el diente final</span>
      <span class="instruction instruction-arch" *ngIf="showArchSelector()">Seleccione el maxilar para la prótesis total</span>
    </div>
  </div>

  <!-- Selector de maxilar -->
  <div class="arch-selector" *ngIf="showArchSelector()">
    <button type="button" class="arch-btn arch-btn-upper" (click)="selectCompleteArch('upper')">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 12 Q12 4, 20 12"/>
      </svg>
      Maxilar Superior
    </button>
    <button type="button" class="arch-btn arch-btn-lower" (click)="selectCompleteArch('lower')">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 12 Q12 20, 20 12"/>
      </svg>
      Maxilar Inferior
    </button>
  </div>

  <!-- Odontogram -->
  <div class="odontogram-grid">
    <!-- Upper Arch -->
    <div class="arch-section upper-arch">
      <div class="arch-label">Arcada Superior</div>
      
      <!-- Anatomical View -->
      <div class="anatomical-row">
        <div *ngFor="let tooth of upperTeeth" 
             class="tooth-anatomical"
             [class.selected]="selectedTooth() === tooth.code"
             [class.hovered]="hoveredTooth() === tooth.code"
             [class.range-start]="rangeStart() === tooth.code"
             [class.range-end]="rangeEnd() === tooth.code"
             [class.in-range]="isToothInRange(tooth.code)"
             [ngStyle]="getToothStyle(tooth.code)"
             (click)="rangeSelectionMode() ? selectToothInRange(tooth.code) : onToothClick(tooth)"
             (mouseenter)="onToothHover(tooth.code)"
             (mouseleave)="onToothHover(null)">
          <div class="tooth-crown" [class]="tooth.type">
            <div class="status-icon" *ngIf="getToothIcon(tooth.code)">{{ getToothIcon(tooth.code) }}</div>
          </div>
          <div class="tooth-root"></div>
        </div>
      </div>

      <!-- Coronal View -->
      <div class="coronal-row">
        <div *ngFor="let tooth of upperTeeth" 
             class="tooth-coronal"
             [class.selected]="selectedTooth() === tooth.code"
             [class.hovered]="hoveredTooth() === tooth.code"
             [class.range-start]="rangeStart() === tooth.code"
             [class.range-end]="rangeEnd() === tooth.code"
             [class.in-range]="isToothInRange(tooth.code)"
             [ngStyle]="getToothStyle(tooth.code)"
             (mouseenter)="onToothHover(tooth.code)"
             (mouseleave)="onToothHover(null)">
          <div class="coronal-circle" (click)="rangeSelectionMode() ? selectToothInRange(tooth.code) : null">
            <div class="surface top" data-surface="occlusal" 
                 [ngStyle]="getSurfaceStyle(tooth.code, 'occlusal')"
                 (click)="!rangeSelectionMode() && toggleSurface(tooth.code, 'occlusal')"></div>
            <div class="surface left" data-surface="mesial" 
                 [ngStyle]="getSurfaceStyle(tooth.code, 'mesial')"
                 (click)="!rangeSelectionMode() && toggleSurface(tooth.code, 'mesial')"></div>
            <div class="surface right" data-surface="distal" 
                 [ngStyle]="getSurfaceStyle(tooth.code, 'distal')"
                 (click)="!rangeSelectionMode() && toggleSurface(tooth.code, 'distal')"></div>
            <div class="surface front" data-surface="vestibular" 
                 [ngStyle]="getSurfaceStyle(tooth.code, 'vestibular')"
                 (click)="!rangeSelectionMode() && toggleSurface(tooth.code, 'vestibular')"></div>
            <div class="surface back" data-surface="lingual" 
                 [ngStyle]="getSurfaceStyle(tooth.code, 'lingual')"
                 (click)="!rangeSelectionMode() && toggleSurface(tooth.code, 'lingual')"></div>
          </div>
          <div class="tooth-number" *ngIf="showNumbers()">{{ tooth.code }}</div>
        </div>
      </div>
    </div>

    <!-- Lower Arch -->
    <div class="arch-section lower-arch">
      <!-- Coronal View -->
      <div class="coronal-row">
        <div *ngFor="let tooth of lowerTeeth" 
             class="tooth-coronal"
             [class.selected]="selectedTooth() === tooth.code"
             [class.hovered]="hoveredTooth() === tooth.code"
             [class.range-start]="rangeStart() === tooth.code"
             [class.range-end]="rangeEnd() === tooth.code"
             [class.in-range]="isToothInRange(tooth.code)"
             [ngStyle]="getToothStyle(tooth.code)"
             (mouseenter)="onToothHover(tooth.code)"
             (mouseleave)="onToothHover(null)">
          <div class="tooth-number" *ngIf="showNumbers()">{{ tooth.code }}</div>
          <div class="coronal-circle" (click)="rangeSelectionMode() ? selectToothInRange(tooth.code) : null">
            <div class="surface top" data-surface="occlusal" 
                 [ngStyle]="getSurfaceStyle(tooth.code, 'occlusal')"
                 (click)="!rangeSelectionMode() && toggleSurface(tooth.code, 'occlusal')"></div>
            <div class="surface left" data-surface="mesial" 
                 [ngStyle]="getSurfaceStyle(tooth.code, 'mesial')"
                 (click)="!rangeSelectionMode() && toggleSurface(tooth.code, 'mesial')"></div>
            <div class="surface right" data-surface="distal" 
                 [ngStyle]="getSurfaceStyle(tooth.code, 'distal')"
                 (click)="!rangeSelectionMode() && toggleSurface(tooth.code, 'distal')"></div>
            <div class="surface front" data-surface="vestibular" 
                 [ngStyle]="getSurfaceStyle(tooth.code, 'vestibular')"
                 (click)="!rangeSelectionMode() && toggleSurface(tooth.code, 'vestibular')"></div>
            <div class="surface back" data-surface="lingual" 
                 [ngStyle]="getSurfaceStyle(tooth.code, 'lingual')"
                 (click)="!rangeSelectionMode() && toggleSurface(tooth.code, 'lingual')"></div>
          </div>
        </div>
      </div>

      <!-- Anatomical View -->
      <div class="anatomical-row">
        <div *ngFor="let tooth of lowerTeeth" 
             class="tooth-anatomical"
             [class.selected]="selectedTooth() === tooth.code"
             [class.hovered]="hoveredTooth() === tooth.code"
             [class.range-start]="rangeStart() === tooth.code"
             [class.range-end]="rangeEnd() === tooth.code"
             [class.in-range]="isToothInRange(tooth.code)"
             [ngStyle]="getToothStyle(tooth.code)"
             (click)="rangeSelectionMode() ? selectToothInRange(tooth.code) : onToothClick(tooth)"
             (mouseenter)="onToothHover(tooth.code)"
             (mouseleave)="onToothHover(null)">
          <div class="tooth-root lower"></div>
          <div class="tooth-crown" [class]="tooth.type">
            <div class="status-icon" *ngIf="getToothIcon(tooth.code)">{{ getToothIcon(tooth.code) }}</div>
          </div>
        </div>
      </div>

      <div class="arch-label">Arcada Inferior</div>
    </div>
  </div>

  <!-- Legend -->
  <div class="legend">
    <div class="legend-section">
      <div class="legend-title">Tratamientos Realizados (Azul):</div>
      <div class="legend-items">
        <div class="legend-item">
          <span class="legend-icon done">✕</span>
          <span>Extracción por caries</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon done">⊗</span>
          <span>Extracción otro motivo</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon done">▲</span>
          <span>Endodoncia por caries</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon done">△</span>
          <span>Endodoncia otro motivo</span>
        </div>
        <div class="legend-item">
          <span class="legend-color done"></span>
          <span>Caries</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon done">■</span>
          <span>Corona</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon done">●━</span>
          <span>Prótesis fija</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon done">⟮⋯⟯</span>
          <span>PPR</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon done">━━━</span>
          <span>Prótesis total</span>
        </div>
      </div>
    </div>

    <div class="legend-section">
      <div class="legend-title">Tratamientos Por Realizar (Rojo):</div>
      <div class="legend-items">
        <div class="legend-item">
          <span class="legend-icon planned">✕</span>
          <span>Extracción por caries</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon planned">⊗</span>
          <span>Extracción otro motivo</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon planned">▲</span>
          <span>Endodoncia por caries</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon planned">△</span>
          <span>Endodoncia otro motivo</span>
        </div>
        <div class="legend-item">
          <span class="legend-color planned"></span>
          <span>Caries</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon planned">■</span>
          <span>Corona</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon planned">●━</span>
          <span>Prótesis fija</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon planned">⟮⋯⟯</span>
          <span>PPR</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon planned">━━━</span>
          <span>Prótesis total</span>
        </div>
      </div>
    </div>
  </div>
</div>
