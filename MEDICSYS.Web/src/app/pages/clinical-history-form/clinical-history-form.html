<app-top-nav></app-top-nav>

<section class="page">
  <header class="page-header">
    <div>
      <p class="eyebrow">Historia clinica</p>
      <h2>Formulario del estudiante</h2>
      <p class="subtitle">Completa cada seccion con precision y envia para revision.</p>
    </div>
    <div class="actions">
      <span *ngIf="history() as h" class="status" [attr.data-status]="h.status">{{ h.status }}</span>
      <button class="btn btn-outline" type="button" (click)="saveDraft()" [disabled]="readonly() || saving()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        {{ isProfessorEditor() ? 'Guardar cambios' : 'Guardar borrador' }}
      </button>
      <button *ngIf="!isProfessorEditor()" class="btn btn-primary" type="button" (click)="submit()" [disabled]="readonly() || saving()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        Enviar a revision
      </button>
    </div>
  </header>

  <div class="card note" *ngIf="history()?.reviewNotes">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
    <div>
      <strong>Observaciones del profesor</strong>
      <p>{{ history()?.reviewNotes }}</p>
    </div>
  </div>

  <div *ngIf="loading()" class="empty">
    <svg class="spinner" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
    Cargando historia clinica...
  </div>

  <div *ngIf="!loading()" class="tabs">
    <button class="tab" [class.active]="activeTab() === 'personal'" (click)="setTab('personal')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      Datos personales
    </button>
    <button class="tab" [class.active]="activeTab() === 'consulta'" (click)="setTab('consulta')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      Datos de consulta
    </button>
    <button class="tab" [class.active]="activeTab() === 'odontograma'" (click)="setTab('odontograma')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      Odontograma
    </button>
    <button class="tab" [class.active]="activeTab() === 'indicadores'" (click)="setTab('indicadores')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      Indicadores
    </button>
    <button class="tab" [class.active]="activeTab() === 'tratamientos'" (click)="setTab('tratamientos')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5"/></svg>
      Tratamientos
    </button>
    <button class="tab" [class.active]="activeTab() === 'medios'" (click)="setTab('medios')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      Medios
    </button>
  </div>

  <form *ngIf="!loading()" class="form" [formGroup]="form">
    <section class="form-section" *ngIf="activeTab() === 'personal'">
      <h3>Datos personales</h3>
      <div class="grid" formGroupName="personal">
        <label class="field">
          Apellidos
          <input class="input" formControlName="lastName" />
        </label>
        <label class="field">
          Nombres
          <input class="input" formControlName="firstName" />
        </label>
        <label class="field">
          C.I.
          <input class="input" formControlName="idNumber" />
        </label>
        <label class="field">
          Genero
          <select class="input" formControlName="gender">
            <option value="">Selecciona</option>
            <option value="Femenino">Femenino</option>
            <option value="Masculino">Masculino</option>
            <option value="Otro">Otro</option>
          </select>
        </label>
        <label class="field">
          Edad
          <input class="input" formControlName="age" />
        </label>
        <label class="field">
          Rango de edad
          <input class="input" formControlName="ageRange" />
        </label>
        <label class="field">
          N° historia clinica
          <input class="input" formControlName="clinicalHistoryNumber" />
        </label>
        <label class="field">
          Direccion
          <input class="input" formControlName="address" />
        </label>
        <label class="field">
          Telefono
          <input class="input" formControlName="phone" />
        </label>
        <label class="field">
          Fecha
          <input class="input" type="date" formControlName="date" />
        </label>
      </div>
    </section>

    <section class="form-section" *ngIf="activeTab() === 'consulta'" formGroupName="consultation">
      <h3>Datos de consulta</h3>
      <div class="stack">
        <label class="field">
          Motivo de consulta
          <textarea class="input" rows="2" formControlName="reason"></textarea>
        </label>
        <label class="field">
          Enfermedad o problema actual
          <textarea class="input" rows="3" formControlName="currentIssue"></textarea>
        </label>
      </div>

      <div class="form-divider">Antecedentes personales y familiares</div>
      <div class="check-grid" formGroupName="antecedentes">
        <label><input type="checkbox" formControlName="alergiaAntibiotico" /> Alergia antibiótico</label>
        <label><input type="checkbox" formControlName="alergiaAnestesia" /> Alergia anestesia</label>
        <label><input type="checkbox" formControlName="hemorragias" /> Hemorragias</label>
        <label><input type="checkbox" formControlName="vih" /> VIH/SIDA</label>
        <label><input type="checkbox" formControlName="tuberculosis" /> Tuberculosis</label>
        <label><input type="checkbox" formControlName="asma" /> Asma</label>
        <label><input type="checkbox" formControlName="diabetes" /> Diabetes</label>
        <label><input type="checkbox" formControlName="hipertension" /> Hipertension</label>
        <label><input type="checkbox" formControlName="cardiaca" /> Enf. cardiaca</label>
        <label><input type="checkbox" formControlName="otros" /> Otros</label>
      </div>

      <div class="form-divider">Signos vitales</div>
      <div class="grid" formGroupName="vitalSigns">
        <label class="field">
          Presion arterial
          <input class="input" formControlName="bloodPressure" />
        </label>
        <label class="field">
          Frecuencia cardiaca
          <input class="input" formControlName="heartRate" />
        </label>
        <label class="field">
          Temperatura °C
          <input class="input" formControlName="temperature" />
        </label>
        <label class="field">
          Frecuencia respiratoria
          <input class="input" formControlName="respiratoryRate" />
        </label>
      </div>

      <div class="form-divider">Examen del sistema estomatognatico</div>
      <div class="check-grid" formGroupName="estomatognatico">
        <label><input type="checkbox" formControlName="labios" (change)="onEstomatognaticoChange('labios', $event)" /> Labios</label>
        <label><input type="checkbox" formControlName="mejillas" (change)="onEstomatognaticoChange('mejillas', $event)" /> Mejillas</label>
        <label><input type="checkbox" formControlName="maxilarSuperior" (change)="onEstomatognaticoChange('maxilarSuperior', $event)" /> Maxilar superior</label>
        <label><input type="checkbox" formControlName="maxilarInferior" (change)="onEstomatognaticoChange('maxilarInferior', $event)" /> Maxilar inferior</label>
        <label><input type="checkbox" formControlName="lengua" (change)="onEstomatognaticoChange('lengua', $event)" /> Lengua</label>
        <label><input type="checkbox" formControlName="paladar" (change)="onEstomatognaticoChange('paladar', $event)" /> Paladar</label>
        <label><input type="checkbox" formControlName="piso" (change)="onEstomatognaticoChange('piso', $event)" /> Piso</label>
        <label><input type="checkbox" formControlName="carrillos" (change)="onEstomatognaticoChange('carrillos', $event)" /> Carrillos</label>
        <label><input type="checkbox" formControlName="glandulasSalivales" (change)="onEstomatognaticoChange('glandulasSalivales', $event)" /> Glandulas salivales</label>
        <label><input type="checkbox" formControlName="orofaringe" (change)="onEstomatognaticoChange('orofaringe', $event)" /> Oro faringe</label>
        <label><input type="checkbox" formControlName="atm" (change)="onEstomatognaticoChange('atm', $event)" /> A.T.M.</label>
        <label><input type="checkbox" formControlName="ganglios" (change)="onEstomatognaticoChange('ganglios', $event)" /> Ganglios</label>
      </div>

      <!-- Modal para detalles -->
      <div class="modal-overlay" *ngIf="estomatognaticoSelected()" (click)="cancelEstomatognaticoDetail()">
        <div class="modal-content" (click)="$event.stopPropagation()" formGroupName="estomatognaticoDetails">
          <div class="modal-header">
            <h3>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
              Detalles - {{ estomatognaticoSelected() === 'labios' ? 'Labios' :
                            estomatognaticoSelected() === 'mejillas' ? 'Mejillas' :
                            estomatognaticoSelected() === 'maxilarSuperior' ? 'Maxilar superior' :
                            estomatognaticoSelected() === 'maxilarInferior' ? 'Maxilar inferior' :
                            estomatognaticoSelected() === 'lengua' ? 'Lengua' :
                            estomatognaticoSelected() === 'paladar' ? 'Paladar' :
                            estomatognaticoSelected() === 'piso' ? 'Piso' :
                            estomatognaticoSelected() === 'carrillos' ? 'Carrillos' :
                            estomatognaticoSelected() === 'glandulasSalivales' ? 'Glándulas salivales' :
                            estomatognaticoSelected() === 'orofaringe' ? 'Oro faringe' :
                            estomatognaticoSelected() === 'atm' ? 'A.T.M.' :
                            estomatognaticoSelected() === 'ganglios' ? 'Ganglios' : '' }}
            </h3>
            <button class="btn-close" type="button" (click)="cancelEstomatognaticoDetail()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
          <div class="modal-body">
            <label class="field">
              Descripción de hallazgos
              <textarea 
                class="input" 
                rows="4" 
                placeholder="Describe los hallazgos encontrados..."
                [formControlName]="estomatognaticoSelected()!"></textarea>
            </label>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline" type="button" (click)="cancelEstomatognaticoDetail()">Cancelar</button>
            <button class="btn btn-primary" type="button" (click)="saveEstomatognaticoDetail()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
              Guardar
            </button>
          </div>
        </div>
      </div>

      <label class="field">
        Observaciones
        <textarea class="input" rows="3" formControlName="notes"></textarea>
      </label>
      <button class="btn btn-outline" type="button" (click)="suggestNotes()" [disabled]="suggesting()">
        {{ suggesting() ? 'Generando sugerencia...' : 'Sugerir notas con IA' }}
      </button>
    </section>

    <section class="form-section" *ngIf="activeTab() === 'odontograma'">
      <h3>Odontograma interactivo</h3>
      <p class="subtitle">Selecciona una marca y haz clic en las superficies dentales para registrar hallazgos.</p>

      <div class="marker-row">
        <button type="button" class="marker marker-caries" [class.active]="marker() === 'caries'" (click)="selectMarker('caries')">
          <span class="marker-icon">●</span>
          Caries
        </button>
        <button type="button" class="marker marker-filled" [class.active]="marker() === 'filled'" (click)="selectMarker('filled')">
          <span class="marker-icon">■</span>
          Restauración
        </button>
        <button type="button" class="marker marker-missing" [class.active]="marker() === 'missing'" (click)="selectMarker('missing')">
          <span class="marker-icon">✕</span>
          Ausente
        </button>
        <button type="button" class="marker marker-extracted" [class.active]="marker() === 'extracted'" (click)="selectMarker('extracted')">
          <span class="marker-icon">⊗</span>
          Extraído
        </button>
        <button type="button" class="marker marker-needs" [class.active]="marker() === 'needs-treatment'" (click)="selectMarker('needs-treatment')">
          <span class="marker-icon">!</span>
          Necesita tratamiento
        </button>
        <button type="button" class="marker marker-crown" [class.active]="marker() === 'crown'" (click)="selectMarker('crown')">
          <span class="marker-icon">♔</span>
          Corona
        </button>
        <button type="button" class="marker marker-implant" [class.active]="marker() === 'implant'" (click)="selectMarker('implant')">
          <span class="marker-icon">⚙</span>
          Implante
        </button>
        <button type="button" class="marker marker-root" [class.active]="marker() === 'root-canal'" (click)="selectMarker('root-canal')">
          <span class="marker-icon">↓</span>
          Endodoncia
        </button>
      </div>

      <app-odontogram-3d
        [state]="odontogram()"
        [activeMarker]="marker()"
        [readonly]="readonly()"
        (stateChange)="updateOdontogram($event)"
      ></app-odontogram-3d>
    </section>

    <section class="form-section" *ngIf="activeTab() === 'indicadores'" formGroupName="indicators">
      <h3>Indicadores de salud bucal</h3>
      <div class="grid">
        <label class="field">
          Higiene oral simplificada
          <input class="input" formControlName="higieneOral" />
        </label>
        <label class="field">
          Enfermedad periodontal
          <input class="input" formControlName="enfermedadPeriodontal" />
        </label>
        <label class="field">
          Mal oclusion
          <input class="input" formControlName="maloclusion" />
        </label>
        <label class="field">
          Fluorosis
          <input class="input" formControlName="fluorosis" />
        </label>
        <label class="field">
          Indice CPO-ceo
          <input class="input" formControlName="indiceCpo" />
        </label>
      </div>
    </section>

    <section class="form-section" *ngIf="activeTab() === 'tratamientos'" formGroupName="treatments">
      <h3>Tratamientos</h3>
      <div class="grid">
        <label class="field">
          Plan de tratamiento
          <textarea class="input" rows="3" formControlName="plan"></textarea>
        </label>
        <label class="field">
          Procedimientos
          <textarea class="input" rows="3" formControlName="procedures"></textarea>
        </label>
      </div>
    </section>

    <section class="form-section" *ngIf="activeTab() === 'medios'" formGroupName="medios">
      <h3>Medios de apoyo</h3>
      <div class="grid">
        <label class="field">
          Descripcion general
          <textarea class="input" rows="3" formControlName="imagenes"></textarea>
        </label>
        <label class="field">
          Notas
          <textarea class="input" rows="3" formControlName="notas"></textarea>
        </label>
      </div>

      <div class="media-upload">
        <label class="field">
          Subir imagen o video
          <input class="input" type="file" accept="image/*,video/*" (change)="onMediaSelected($event)" [disabled]="readonly() || uploadingMedia()" multiple />
        </label>
        <p class="hint" *ngIf="uploadingMedia()">Subiendo archivos...</p>
      </div>

      <div class="media-grid" *ngIf="mediaAssets().length > 0">
        <div class="media-card" *ngFor="let asset of mediaAssets()">
          <img *ngIf="isImage(asset)" [src]="asset.url" [alt]="asset.fileName" />
          <video *ngIf="isVideo(asset)" [src]="asset.url" controls></video>
          <div class="media-meta">
            <span class="file-name">{{ asset.fileName }}</span>
            <span class="file-date">{{ asset.uploadedAt | date:'medium' }}</span>
          </div>
        </div>
      </div>
    </section>
  </form>
</section>
