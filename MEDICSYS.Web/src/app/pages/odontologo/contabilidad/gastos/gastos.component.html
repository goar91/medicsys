<div class="gastos-container">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <div class="header-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M17 9V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2m2 4h10a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2Zm7-5a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
        </svg>
      </div>
      <div class="header-text">
        <h1>Gestión de Gastos</h1>
        <p>Control y seguimiento de gastos operacionales</p>
      </div>
    </div>
    <button class="btn-new" (click)="openCreateModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M12 5v14m-7-7h14" stroke-linecap="round" stroke-width="2"/>
      </svg>
      Nuevo Gasto
    </button>
  </div>

  <!-- Summary Cards -->
  @if (summary()) {
    <div class="summary-cards">
      <div class="summary-card red">
        <div class="summary-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
          </svg>
        </div>
        <div class="summary-content">
          <div class="summary-label">Total Gastos</div>
          <div class="summary-value">${{ summary()!.totalExpenses | number:'1.2-2' }}</div>
        </div>
      </div>

      <div class="summary-card orange">
        <div class="summary-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
          </svg>
        </div>
        <div class="summary-content">
          <div class="summary-label">Este Mes</div>
          <div class="summary-value">${{ summary()!.monthExpenses | number:'1.2-2' }}</div>
        </div>
      </div>

      <div class="summary-card yellow">
        <div class="summary-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M3 13h8V3H3v10Zm0 8h8v-6H3v6Zm10 0h8V11h-8v10Zm0-18v6h8V3h-8Z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
          </svg>
        </div>
        <div class="summary-content">
          <div class="summary-label">Esta Semana</div>
          <div class="summary-value">${{ summary()!.weekExpenses | number:'1.2-2' }}</div>
        </div>
      </div>
    </div>
  }

  <!-- Filters -->
  <div class="filters-section">
    <div class="filters-grid">
      <div class="filter-group">
        <label>Categoría</label>
        <select [(ngModel)]="filterCategory" (change)="loadExpenses()" [ngModelOptions]="{standalone: true}">
          <option value="">Todas</option>
          @for (cat of categories; track cat.value) {
            <option [value]="cat.value">{{ cat.label }}</option>
          }
        </select>
      </div>

      <div class="filter-group">
        <label>Método de Pago</label>
        <select [(ngModel)]="filterPaymentMethod" (change)="loadExpenses()" [ngModelOptions]="{standalone: true}">
          <option value="">Todos</option>
          @for (method of paymentMethods; track method.value) {
            <option [value]="method.value">{{ method.label }}</option>
          }
        </select>
      </div>

      <div class="filter-group">
        <label>Desde</label>
        <input type="date" [(ngModel)]="filterStartDate" (change)="loadExpenses()" [ngModelOptions]="{standalone: true}">
      </div>

      <div class="filter-group">
        <label>Hasta</label>
        <input type="date" [(ngModel)]="filterEndDate" (change)="loadExpenses()" [ngModelOptions]="{standalone: true}">
      </div>

      <div class="filter-actions">
        <button class="btn-clear" (click)="clearFilters()">Limpiar Filtros</button>
      </div>
    </div>
  </div>

  <!-- Expenses Table -->
  <div class="table-container">
    <div class="table-header">
      <h2>Listado de Gastos</h2>
      <div class="table-info">
        <span>Total: ${{ totalExpenses() | number:'1.2-2' }}</span>
        <span class="separator">•</span>
        <span>{{ filteredExpenses().length }} registros</span>
      </div>
    </div>

    @if (loading()) {
      <div class="loading">Cargando gastos...</div>
    } @else if (filteredExpenses().length === 0) {
      <div class="no-data">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2Z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
        </svg>
        <p>No se encontraron gastos</p>
      </div>
    } @else {
      <table class="expenses-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Descripción</th>
            <th>Categoría</th>
            <th>Proveedor</th>
            <th>Método de Pago</th>
            <th>Monto</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (expense of filteredExpenses(); track expense.id) {
            <tr>
              <td>{{ expense.expenseDate | date:'dd/MM/yyyy' }}</td>
              <td>
                <div class="description">
                  <span class="desc-text">{{ expense.description }}</span>
                  @if (expense.invoiceNumber) {
                    <span class="invoice-badge">{{ expense.invoiceNumber }}</span>
                  }
                </div>
              </td>
              <td>
                <span class="category-badge">{{ getCategoryLabel(expense.category) }}</span>
              </td>
              <td>{{ expense.supplier || '-' }}</td>
              <td>
                <span class="payment-badge" [class]="'payment-' + expense.paymentMethod.toLowerCase()">
                  {{ expense.paymentMethod }}
                </span>
              </td>
              <td class="amount">${{ expense.amount | number:'1.2-2' }}</td>
              <td>
                <div class="actions">
                  <button class="btn-action edit" (click)="openEditModal(expense)" title="Editar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                    </svg>
                  </button>
                  <button class="btn-action delete" (click)="deleteExpense(expense.id)" title="Eliminar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    }
  </div>

  <!-- Modal -->
  @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ isEditing() ? 'Editar Gasto' : 'Nuevo Gasto' }}</h2>
          <button class="btn-close" (click)="closeModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-width="2"/>
            </svg>
          </button>
        </div>

        <form [formGroup]="expenseForm" (ngSubmit)="saveExpense()">
          <div class="form-section">
            <div class="section-bar"></div>
            <h3>Información General</h3>

            <div class="form-row">
              <div class="form-group full">
                <label>Descripción *</label>
                <input type="text" formControlName="description" placeholder="Ej: Pago de alquiler del consultorio">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Monto *</label>
                <div class="input-with-prefix">
                  <span class="prefix">$</span>
                  <input type="number" formControlName="amount" step="0.01" min="0">
                </div>
              </div>

              <div class="form-group">
                <label>Fecha *</label>
                <input type="date" formControlName="expenseDate">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Categoría *</label>
                <select formControlName="category">
                  <option value="">Seleccione...</option>
                  @for (cat of categories; track cat.value) {
                    <option [value]="cat.value">{{ cat.label }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label>Método de Pago *</label>
                <select formControlName="paymentMethod">
                  @for (method of paymentMethods; track method.value) {
                    <option [value]="method.value">{{ method.label }}</option>
                  }
                </select>
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="section-bar"></div>
            <h3>Información Adicional</h3>

            <div class="form-row">
              <div class="form-group">
                <label>Número de Factura</label>
                <input type="text" formControlName="invoiceNumber" placeholder="001-001-123456">
              </div>

              <div class="form-group">
                <label>Proveedor</label>
                <input type="text" formControlName="supplier" placeholder="Nombre del proveedor">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group full">
                <label>Notas</label>
                <textarea formControlName="notes" rows="3" placeholder="Notas adicionales..."></textarea>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn-secondary" (click)="closeModal()">Cancelar</button>
            <button type="submit" class="btn-primary" [disabled]="expenseForm.invalid">
              {{ isEditing() ? 'Guardar Cambios' : 'Crear Gasto' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
