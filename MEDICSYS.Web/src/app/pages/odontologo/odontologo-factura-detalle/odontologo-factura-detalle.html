<app-top-nav *ngIf="!printMode()"></app-top-nav>

<section class="page factura-detalle">
  <header class="detalle-header" *ngIf="!printMode()">
    <button class="btn btn-outline" type="button" (click)="back()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      Volver a Facturaci贸n
    </button>
    <div class="header-actions">
      <button class="btn btn-outline" type="button" (click)="print()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        Imprimir
      </button>
      <button class="btn btn-primary" type="button" *ngIf="invoice()?.status === 'Pending'" (click)="sendToSri()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        Enviar al SRI
      </button>
    </div>
  </header>

  <div class="factura-shell" *ngIf="invoice() as factura">
    <div class="factura-top">
      <div class="card company-card">
        <div class="company-header">
          <div class="logo">MD</div>
          <div>
            <h2>MEDICSYS Dental</h2>
            <p>CONSULTORIO DENTAL DR. CARLOS MENDOZA</p>
            <p>RUC: 0999999999001</p>
            <p>Av. Principal 123 y Secundaria, Cuenca - Ecuador</p>
          </div>
        </div>
      </div>

      <div class="card invoice-card">
        <!-- C贸digo de barras y Autorizaci贸n SRI encima de la factura -->
        <div class="sri-barcode-header" *ngIf="factura.sriAccessKey && factura.sriAuthorizationNumber">
          <div class="barcode-container">
            <div class="barcode">
              @for (segment of getAccessKeySegments(factura.sriAccessKey); track $index) {
                <div class="barcode-bar" [style.width.px]="segment.width" [style.opacity]="segment.opacity"></div>
              }
            </div>
          </div>
          <div class="sri-auth-inline">
            <span class="sri-auth-label-inline">N掳 AUTORIZACIN SRI:</span>
            <span class="sri-auth-number-inline">{{ factura.sriAuthorizationNumber }}</span>
          </div>
        </div>

        <div class="invoice-number">
          <span>Factura</span>
          <h3>{{ factura.number }}</h3>
          <span class="status" [attr.data-status]="factura.status">{{ formatStatus(factura.status) }}</span>
        </div>
        <div class="invoice-meta">
          <div>
            <span>Fecha de emisi贸n</span>
            <strong>{{ factura.issuedAt | date:'dd/MM/yyyy HH:mm' }}</strong>
          </div>
          <div>
            <span>Forma de pago</span>
            <strong>{{ formatPayment(factura.paymentMethod) }}</strong>
          </div>
          <div>
            <span>Ambiente SRI</span>
            <strong>{{ factura.sriEnvironment }}</strong>
          </div>
          <div *ngIf="factura.cardType">
            <span>Tarjeta</span>
            <strong>{{ factura.cardType }}</strong>
          </div>
        </div>
      </div>
    </div>

    <div class="card customer-card">
      <h4>Datos del Cliente</h4>
      <div class="customer-grid">
        <div>
          <span>Nombre / Raz贸n Social</span>
          <strong>{{ factura.customer.name }}</strong>
        </div>
        <div>
          <span>Identificaci贸n</span>
          <strong>{{ factura.customer.identification }}</strong>
        </div>
        <div>
          <span>Email</span>
          <strong>{{ factura.customer.email || 'No registra' }}</strong>
        </div>
        <div>
          <span>Direcci贸n</span>
          <strong>{{ factura.customer.address || 'No registra' }}</strong>
        </div>
      </div>
    </div>

    <div class="card items-card">
      <table class="items-table">
        <thead>
          <tr>
            <th>Descripci贸n</th>
            <th>Cant.</th>
            <th>Precio</th>
            <th>Desc.</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of factura.items">
            <td>{{ item.description }}</td>
            <td>{{ item.quantity }}</td>
            <td>{{ item.unitPrice | currency:'USD':'symbol':'1.2-2' }}</td>
            <td>{{ item.discountPercent }}%</td>
            <td>{{ item.subtotal | currency:'USD':'symbol':'1.2-2' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="totals-grid">
      <div class="card notes-card" *ngIf="factura.observations">
        <h4>Observaciones</h4>
        <p>{{ factura.observations }}</p>
      </div>
      <div class="card totals-card">
        <h4>Resumen</h4>
        <div class="total-row">
          <span>Subtotal</span>
          <strong>{{ factura.subtotal | currency:'USD':'symbol':'1.2-2' }}</strong>
        </div>
        <div class="total-row">
          <span>IVA</span>
          <strong>{{ factura.tax | currency:'USD':'symbol':'1.2-2' }}</strong>
        </div>
        <div class="total-row" *ngIf="factura.cardFeeAmount">
          <span>Recargo tarjeta</span>
          <strong>{{ factura.cardFeeAmount | currency:'USD':'symbol':'1.2-2' }}</strong>
        </div>
        <div class="total-row total-final">
          <span>Total a cobrar</span>
          <strong>{{ factura.totalToCharge | currency:'USD':'symbol':'1.2-2' }}</strong>
        </div>
      </div>
    </div>

    <div class="card sri-card">
      <div class="sri-header">
        <h4>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
          Estado SRI
        </h4>
        <span class="sri-status" [attr.data-status]="factura.status">
          <svg *ngIf="factura.status === 'Authorized'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <svg *ngIf="factura.status === 'Pending'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          <svg *ngIf="factura.status === 'Rejected'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          {{ formatStatus(factura.status) }}
        </span>
      </div>

      <div class="sri-content">
        <!-- Informaci贸n principal del SRI -->
        <div class="sri-info-section">
          <div class="sri-info-row">
            <div class="sri-info-item">
              <span class="sri-label">Ambiente</span>
              <span class="sri-value sri-environment" [attr.data-env]="factura.sriEnvironment">
                {{ factura.sriEnvironment === 'Produccion' ? ' Producci贸n' : ' Pruebas' }}
              </span>
            </div>
            <div class="sri-info-item" *ngIf="factura.sriAuthorizedAt">
              <span class="sri-label">Fecha de Autorizaci贸n</span>
              <span class="sri-value">{{ factura.sriAuthorizedAt | date:'dd/MM/yyyy HH:mm:ss' }}</span>
            </div>
          </div>

          <!-- Clave de Acceso (el c贸digo de barras ya est谩 en la secci贸n factura) -->
          <div class="sri-accesskey-section" *ngIf="factura.sriAccessKey">
            <div class="sri-accesskey-box">
              <span class="sri-accesskey-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <line x1="7" y1="7" x2="7" y2="17"/>
                  <line x1="10" y1="7" x2="10" y2="17"/>
                  <line x1="13" y1="7" x2="13" y2="17"/>
                  <line x1="16" y1="7" x2="16" y2="17"/>
                </svg>
                Clave de Acceso (49 d铆gitos)
              </span>

              <!-- N煤mero dividido en grupos para mejor legibilidad -->
              <div class="sri-accesskey-number">
                @for (group of splitAccessKey(factura.sriAccessKey); track $index) {
                  <span class="accesskey-group">{{ group }}</span>
                }
              </div>
            </div>
          </div>

          <!-- Mensajes del SRI -->
          <div class="sri-messages" *ngIf="factura.sriMessages">
            <span class="sri-messages-label">Mensajes SRI:</span>
            <p class="sri-messages-text">{{ factura.sriMessages }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card loading" *ngIf="loading()">
    <p>Cargando factura...</p>
  </div>
</section>
