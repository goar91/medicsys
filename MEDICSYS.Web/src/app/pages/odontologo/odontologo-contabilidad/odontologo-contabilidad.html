<app-top-nav></app-top-nav>

<section class="page contabilidad-page">
  <header class="page-header">
    <div>
      <p class="eyebrow">ğŸ’° Contabilidad</p>
      <h2>Resumen financiero del consultorio</h2>
      <p class="subtitle">Controla ingresos, egresos y el flujo de caja con base en tu plan financiero.</p>
    </div>
    <div class="header-actions">
      <div class="filters">
        <label>
          ğŸ“… Desde
          <input class="input" type="date" [value]="fromDate()" (change)="fromDate.set($any($event.target).value); applyFilters()">
        </label>
        <label>
          ğŸ“… Hasta
          <input class="input" type="date" [value]="toDate()" (change)="toDate.set($any($event.target).value); applyFilters()">
        </label>
        <label>
          ğŸ·ï¸ Tipo
          <select class="input" [value]="filterType()" (change)="filterType.set($any($event.target).value); applyFilters()">
            <option value="">Todos</option>
            <option value="Income">Ingresos</option>
            <option value="Expense">Egresos</option>
          </select>
        </label>
      </div>
      <div class="action-buttons">
        <button class="btn btn-outline" (click)="toggleViewMode()">
          {{ viewMode() === 'list' ? 'ğŸ“Š Ver GrÃ¡fico' : 'ğŸ“‹ Ver Lista' }}
        </button>
        <button class="btn btn-outline" (click)="exportToCSV()">
          ğŸ“¥ Exportar CSV
        </button>
      </div>
    </div>
  </header>

  <div class="summary-grid" *ngIf="summary() as summary">
    <div class="card summary-card income">
      <div class="card-icon">ğŸ“ˆ</div>
      <div class="card-content">
        <p>Ingresos</p>
        <h3>{{ summary.totalIncome | currency:'USD':'symbol':'1.2-2' }}</h3>
        <span>Periodo seleccionado</span>
      </div>
    </div>
    <div class="card summary-card expense">
      <div class="card-icon">ğŸ“‰</div>
      <div class="card-content">
        <p>Egresos</p>
        <h3>{{ summary.totalExpense | currency:'USD':'symbol':'1.2-2' }}</h3>
        <span>Control de gastos</span>
      </div>
    </div>
    <div class="card summary-card net">
      <div class="card-icon">ğŸ’µ</div>
      <div class="card-content">
        <p>Utilidad</p>
        <h3 [class.negative]="summary.net < 0">{{ summary.net | currency:'USD':'symbol':'1.2-2' }}</h3>
        <span>Saldo del periodo</span>
      </div>
    </div>
  </div>

  <div class="content-grid">
    <!-- Chart View -->
    <div class="card chart-card" *ngIf="viewMode() === 'chart'">
      <div class="card-header">
        <div>
          <h3>ğŸ“Š Tendencia Mensual</h3>
          <p>Ingresos vs Egresos Ãºltimos 6 meses</p>
        </div>
      </div>
      <div class="chart-container" *ngIf="chartData().length > 0">
        <div class="chart-bars">
          <div class="chart-bar-group" *ngFor="let point of chartData()">
            <div class="bars">
              <div class="bar income-bar" 
                   [style.height.%]="getChartBarHeight(point.income)"
                   [title]="'Ingresos: ' + (point.income | currency:'USD':'symbol':'1.2-2')">
              </div>
              <div class="bar expense-bar" 
                   [style.height.%]="getChartBarHeight(point.expense)"
                   [title]="'Egresos: ' + (point.expense | currency:'USD':'symbol':'1.2-2')">
              </div>
            </div>
            <div class="bar-label">{{ point.label }}</div>
          </div>
        </div>
        <div class="chart-legend">
          <div class="legend-item">
            <span class="legend-color income"></span>
            <span>Ingresos</span>
          </div>
          <div class="legend-item">
            <span class="legend-color expense"></span>
            <span>Egresos</span>
          </div>
        </div>
      </div>
      <div class="empty" *ngIf="chartData().length === 0">
        <p>No hay datos suficientes para mostrar el grÃ¡fico.</p>
      </div>
    </div>
    
    <!-- List View -->
    <div class="card ledger-card" *ngIf="viewMode() === 'list'">
      <div class="card-header">
        <div>
          <h3>ğŸ“– Libro diario</h3>
          <p>Registro de movimientos contables</p>
        </div>
      </div>
      <div class="ledger-list" *ngIf="entries().length > 0">
        <article class="ledger-item" *ngFor="let entry of entries()" 
                 [class.editing]="editingEntry()?.id === entry.id">
          <div class="entry-content">
            <div class="entry-header">
              <strong>{{ entry.description }}</strong>
              <div class="entry-actions">
                <button class="btn-icon" (click)="editEntry(entry)" title="Editar">âœï¸</button>
                <button class="btn-icon danger" (click)="confirmDelete(entry.id)" title="Eliminar">ğŸ—‘ï¸</button>
              </div>
            </div>
            <span class="entry-meta">
              {{ entry.date | date:'dd/MM/yyyy' }} Â· {{ entry.categoryGroup }} / {{ entry.categoryName }}
            </span>
            <small *ngIf="entry.source === 'Invoice'" class="entry-source">ğŸ§¾ Generado desde factura</small>
            <small class="entry-payment">ğŸ’³ {{ entry.paymentMethod }}</small>
          </div>
          <div class="amount" [attr.data-type]="entry.type">
            {{ entry.type === 'Income' ? '+' : '-' }}{{ entry.amount | currency:'USD':'symbol':'1.2-2' }}
          </div>
          
          <!-- Delete Confirmation -->
          <div class="delete-confirm" *ngIf="showDeleteConfirm() === entry.id">
            <p>Â¿Eliminar este movimiento?</p>
            <div class="confirm-actions">
              <button class="btn btn-sm btn-danger" (click)="deleteEntry(entry.id)">Eliminar</button>
              <button class="btn btn-sm btn-outline" (click)="cancelDelete()">Cancelar</button>
            </div>
          </div>
        </article>
      </div>
      <div class="empty" *ngIf="entries().length === 0">
        <p>No hay movimientos en este periodo.</p>
      </div>
    </div>

    <div class="sidebar">
      <div class="card form-card">
        <h3>{{ editingEntry() ? 'âœï¸ Editar movimiento' : 'â• Nuevo movimiento' }}</h3>
        <form [formGroup]="entryForm" (ngSubmit)="createEntry()">
          <label>
            Tipo
            <select class="input" formControlName="type">
              <option value="Expense">ğŸ’¸ Egreso</option>
              <option value="Income">ğŸ’° Ingreso</option>
            </select>
          </label>
          <label>
            CategorÃ­a
            <select class="input" formControlName="categoryId">
              <option value="" disabled>Selecciona una categorÃ­a</option>
              <option *ngFor="let category of categories()" [value]="category.id">
                {{ category.group }} Â· {{ category.name }}
              </option>
            </select>
          </label>
          <label>
            Fecha
            <input class="input" type="date" formControlName="date">
          </label>
          <label>
            DescripciÃ³n
            <input class="input" type="text" formControlName="description" placeholder="Ej: Pago de arriendo">
          </label>
          <label>
            Monto
            <input class="input" type="number" formControlName="amount" step="0.01" placeholder="0.00">
          </label>
          <label>
            Forma de pago
            <select class="input" formControlName="paymentMethod">
              <option value="Cash">ğŸ’µ Efectivo</option>
              <option value="Card">ğŸ’³ Tarjeta</option>
              <option value="Transfer">ğŸ¦ Transferencia</option>
              <option value="Other">ğŸ“‹ Otro</option>
            </select>
          </label>
          <label>
            Referencia
            <input class="input" type="text" formControlName="reference" placeholder="Opcional">
          </label>
          <div class="form-actions">
            <button class="btn btn-primary" type="submit">
              {{ editingEntry() ? 'Actualizar' : 'Registrar movimiento' }}
            </button>
            <button class="btn btn-outline" type="button" (click)="cancelEdit()" *ngIf="editingEntry()">
              Cancelar
            </button>
          </div>
        </form>
      </div>

      <div class="card categories-card">
        <h3>ğŸ“Š Plan financiero</h3>
        <div class="category-list">
          <div class="category-item" *ngFor="let category of categories()">
            <div>
              <strong>{{ category.name }}</strong>
              <span>{{ category.group }}</span>
            </div>
            <div class="category-meta">
              <span class="category-amount" [class.over-budget]="budgetPercent(category) > 100">
                {{ categoryTotal(category) | currency:'USD':'symbol':'1.2-2' }}
              </span>
              <div class="progress" *ngIf="category.monthlyBudget">
                <div class="progress-bar" 
                     [style.width.%]="budgetPercent(category)"
                     [class.over]="budgetPercent(category) > 100"></div>
              </div>
              <small *ngIf="category.monthlyBudget" class="budget-info">
                {{ budgetPercent(category) }}% de {{ category.monthlyBudget | currency:'USD':'symbol':'1.0-0' }}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
