<app-top-nav></app-top-nav>

<section class="page odontologo-inventario">
  <header class="page-header">
    <div>
      <p class="eyebrow">Gestión de Inventario</p>
      <h2>Inventario de Materiales y Suministros</h2>
      <p class="subtitle">Control de stock y alertas de inventario</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline" type="button" (click)="loadData()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        Actualizar
      </button>
      <button class="btn btn-primary" type="button" (click)="showNewItemForm.set(true)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
        Nuevo Artículo
      </button>
    </div>
  </header>

  <!-- Métricas de inventario -->
  <div class="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="metric-card" style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; align-items: flex-start; justify-content: space-between;">
        <div>
          <p style="color: #6b7280; font-size: 0.875rem; margin: 0 0 0.5rem 0;">Total de Items</p>
          <h3 style="color: #111827; font-size: 2rem; font-weight: 700; margin: 0;">{{ items().length }}</h3>
          <p style="color: #6b7280; font-size: 0.75rem; margin: 0.5rem 0 0 0;">En inventario</p>
        </div>
        <div style="background: #f3f4f6; padding: 0.75rem; border-radius: 8px;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
        </div>
      </div>
    </div>

    <div class="metric-card" style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; align-items: flex-start; justify-content: space-between;">
        <div>
          <p style="color: #6b7280; font-size: 0.875rem; margin: 0 0 0.5rem 0;">Stock Bajo</p>
          <h3 style="color: #f59e0b; font-size: 2rem; font-weight: 700; margin: 0;">{{ lowStockCount() }}</h3>
          <p style="color: #6b7280; font-size: 0.75rem; margin: 0.5rem 0 0 0;">Requieren reposición</p>
        </div>
        <div style="background: #fef3c7; padding: 0.75rem; border-radius: 8px;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        </div>
      </div>
    </div>

    <div class="metric-card" style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; align-items: flex-start; justify-content: space-between;">
        <div>
          <p style="color: #6b7280; font-size: 0.875rem; margin: 0 0 0.5rem 0;">Agotados</p>
          <h3 style="color: #ef4444; font-size: 2rem; font-weight: 700; margin: 0;">{{ outOfStockCount() }}</h3>
          <p style="color: #6b7280; font-size: 0.75rem; margin: 0.5rem 0 0 0;">Sin stock</p>
        </div>
        <div style="background: #fee2e2; padding: 0.75rem; border-radius: 8px;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
        </div>
      </div>
    </div>

    <div class="metric-card" style="background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; align-items: flex-start; justify-content: space-between;">
        <div>
          <p style="color: #6b7280; font-size: 0.875rem; margin: 0 0 0.5rem 0;">Por Expirar</p>
          <h3 style="color: #f59e0b; font-size: 2rem; font-weight: 700; margin: 0;">{{ expiringCount() }}</h3>
          <p style="color: #6b7280; font-size: 0.75rem; margin: 0.5rem 0 0 0;">En 30 días</p>
        </div>
        <div style="background: #fef3c7; padding: 0.75rem; border-radius: 8px;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Alertas activas -->
  <div class="card alerts-section" *ngIf="unresolvedAlerts().length > 0" style="margin-bottom: 2rem; background: #fef3c7; border-color: #f59e0b;">
    <div class="card-header" style="border-bottom: 1px solid #fcd34d;">
      <h3 style="color: #92400e; margin: 0;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 0.5rem;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        Alertas Activas ({{ unresolvedAlerts().length }})
      </h3>
    </div>
    <div style="padding: 1rem;">
      <div *ngFor="let alert of unresolvedAlerts()" 
           [attr.data-type]="getAlertTypeClass(alert.type)"
           style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border-radius: 8px; border-left: 4px solid;"
           [style.border-left-color]="getAlertTypeClass(alert.type) === 'danger' ? '#ef4444' : '#f59e0b'">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle *ngIf="getAlertIcon(alert.type) === 'alert-circle'" cx="12" cy="12" r="10"/>
            <line *ngIf="getAlertIcon(alert.type) === 'alert-circle'" x1="12" y1="8" x2="12" y2="12"/>
            <line *ngIf="getAlertIcon(alert.type) === 'alert-circle'" x1="12" y1="16" x2="12.01" y2="16"/>
          </svg>
          <div>
            <p style="margin: 0; font-weight: 500; color: #111827;">{{ alert.message }}</p>
            <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: #6b7280;">{{ alert.createdAt | date: 'short' }}</p>
          </div>
        </div>
        <button class="btn btn-sm btn-outline" (click)="resolveAlert(alert.id)">Resolver</button>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
    <button class="chip" [class.active]="filter() === 'all'" (click)="setFilter('all')">
      Todos ({{ items().length }})
    </button>
    <button class="chip" [class.active]="filter() === 'low-stock'" (click)="setFilter('low-stock')">
      Stock Bajo ({{ lowStockCount() }})
    </button>
    <button class="chip" [class.active]="filter() === 'expiring'" (click)="setFilter('expiring')">
      Por Expirar ({{ expiringCount() }})
    </button>
  </div>

  <!-- Lista de inventario -->
  <div class="card">
    <div *ngIf="loading()" class="empty">
      <svg class="spinner" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
      Cargando inventario...
    </div>

    <div *ngIf="!loading() && filteredItems().length === 0" class="empty">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
      <p>No hay artículos en el inventario.</p>
    </div>

    <div *ngIf="!loading() && filteredItems().length > 0" class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Artículo</th>
            <th>SKU</th>
            <th>Cantidad</th>
            <th>Precio Unit.</th>
            <th>Proveedor</th>
            <th>Expiración</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of filteredItems()" [class.table-danger]="item.quantity === 0" [class.table-warning]="item.isLowStock && item.quantity > 0">
            <td>
              <strong>{{ item.name }}</strong>
              <br>
              <small style="color: #6b7280;">{{ item.description || '-' }}</small>
            </td>
            <td>{{ item.sku || '-' }}</td>
            <td>
              <strong [style.color]="item.quantity === 0 ? '#ef4444' : item.isLowStock ? '#f59e0b' : '#059669'">
                {{ item.quantity }}
              </strong>
              / {{ item.minimumQuantity }}
            </td>
            <td>${{ item.unitPrice | number: '1.2-2' }}</td>
            <td>{{ item.supplier || '-' }}</td>
            <td>
              <span *ngIf="item.expirationDate" 
                    [style.color]="item.isExpiringSoon ? '#f59e0b' : '#6b7280'">
                {{ item.expirationDate | date: 'dd/MM/yyyy' }}
              </span>
              <span *ngIf="!item.expirationDate">-</span>
            </td>
            <td>
              <span class="badge" 
                    [class.badge-danger]="item.quantity === 0"
                    [class.badge-warning]="item.isLowStock && item.quantity > 0"
                    [class.badge-success]="!item.isLowStock && item.quantity > 0">
                {{ item.quantity === 0 ? 'Agotado' : item.isLowStock ? 'Stock Bajo' : 'OK' }}
              </span>
            </td>
            <td>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-sm btn-outline" (click)="editItem(item)">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                  Editar
                </button>
                <button class="btn btn-sm btn-danger" (click)="deleteItem(item.id)">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                  Eliminar
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
<!-- Modal para nuevo/editar artículo -->
<div class="modal-overlay" *ngIf="showNewItemForm()" (click)="onModalBackdropClick($event)">
  <div class="modal-container" style="max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
    <div class="modal-card">
      <header class="modal-card-header">
        <div class="modal-header-content">
          <div class="modal-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
              <line x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
          </div>
          <div>
            <h2 class="modal-title">{{ editingItem() ? 'Editar Artículo' : 'Nuevo Artículo de Inventario' }}</h2>
            <p class="modal-subtitle">{{ editingItem() ? 'Actualiza la información del artículo' : 'Registra un nuevo artículo en el inventario' }}</p>
          </div>
        </div>
        <button type="button" class="modal-close-btn" (click)="closeModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </header>

      <form [formGroup]="itemForm" (ngSubmit)="saveItem()">
        <div class="modal-card-body">
          <!-- Información General -->
          <div class="form-section">
            <h3 class="section-title">Información General</h3>
            
            <div class="form-field">
              <label class="field-label required">Nombre del Artículo</label>
              <input 
                type="text" 
                formControlName="name" 
                class="field-input" 
                placeholder="Ej: Guantes de látex talla M"
                [class.error]="itemForm.get('name')?.invalid && itemForm.get('name')?.touched"
              />
              <span class="field-error" *ngIf="itemForm.get('name')?.invalid && itemForm.get('name')?.touched">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="8" x2="12" y2="12"/>
                  <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                El nombre del artículo es obligatorio
              </span>
            </div>

            <div class="form-field">
              <label class="field-label">Descripción</label>
              <textarea 
                formControlName="description" 
                class="field-input field-textarea" 
                rows="3" 
                placeholder="Descripción detallada del artículo (opcional)"
              ></textarea>
              <span class="field-hint">Agrega detalles adicionales sobre el artículo</span>
            </div>

            <div class="form-row-2">
              <div class="form-field">
                <label class="field-label">Código SKU</label>
                <input 
                  type="text" 
                  formControlName="sku" 
                  class="field-input" 
                  placeholder="SKU-001"
                />
                <span class="field-hint">Código único de identificación</span>
              </div>

              <div class="form-field">
                <label class="field-label">Proveedor</label>
                <input 
                  type="text" 
                  formControlName="supplier" 
                  class="field-input" 
                  placeholder="Nombre del proveedor"
                />
              </div>
            </div>
          </div>

          <!-- Stock y Precios -->
          <div class="form-section">
            <h3 class="section-title">Stock y Precios</h3>
            
            <div class="form-row-2">
              <div class="form-field">
                <label class="field-label required">Cantidad Actual</label>
                <div class="input-with-icon">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                  </svg>
                  <input 
                    type="number" 
                    formControlName="quantity" 
                    class="field-input with-icon" 
                    min="0" 
                    placeholder="0"
                    [class.error]="itemForm.get('quantity')?.invalid && itemForm.get('quantity')?.touched"
                  />
                </div>
                <span class="field-hint">Unidades en stock</span>
              </div>

              <div class="form-field">
                <label class="field-label required">Stock Mínimo</label>
                <div class="input-with-icon">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                  <input 
                    type="number" 
                    formControlName="minimumQuantity" 
                    class="field-input with-icon" 
                    min="0" 
                    placeholder="0"
                    [class.error]="itemForm.get('minimumQuantity')?.invalid && itemForm.get('minimumQuantity')?.touched"
                  />
                </div>
                <span class="field-hint">Alertar cuando esté por debajo</span>
              </div>
            </div>

            <div class="form-row-2">
              <div class="form-field">
                <label class="field-label required">Precio Unitario</label>
                <div class="input-with-prefix">
                  <span class="input-prefix">$</span>
                  <input 
                    type="number" 
                    formControlName="unitPrice" 
                    class="field-input with-prefix" 
                    step="0.01" 
                    min="0" 
                    placeholder="0.00"
                    [class.error]="itemForm.get('unitPrice')?.invalid && itemForm.get('unitPrice')?.touched"
                  />
                </div>
                <span class="field-hint">Precio por unidad</span>
              </div>

              <div class="form-field">
                <label class="field-label">Fecha de Expiración</label>
                <div class="input-with-icon">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                  </svg>
                  <input 
                    type="date" 
                    formControlName="expirationDate" 
                    class="field-input with-icon"
                  />
                </div>
                <span class="field-hint">Fecha de vencimiento (opcional)</span>
              </div>
            </div>
          </div>

          <!-- Valor Total (calculado) -->
          <div class="form-section" *ngIf="itemForm.get('quantity')?.value && itemForm.get('unitPrice')?.value">
            <div class="value-summary">
              <div class="value-label">Valor Total del Stock</div>
              <div class="value-amount">${{ ((itemForm.get('quantity')?.value || 0) * (itemForm.get('unitPrice')?.value || 0)).toFixed(2) }}</div>
            </div>
          </div>
        </div>

        <footer class="modal-card-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="loading()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="itemForm.invalid || loading()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline *ngIf="!loading()" points="20 6 9 17 4 12"/>
              <circle *ngIf="loading()" cx="12" cy="12" r="10" class="spinner"/>
            </svg>
            {{ loading() ? 'Guardando...' : (editingItem() ? 'Actualizar Artículo' : 'Crear Artículo') }}
          </button>
        </footer>
      </form>
    </div>
  </div>
</div>
