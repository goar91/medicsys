<app-top-nav></app-top-nav>

<section class="page facturacion-page">
  <header class="page-header">
    <div>
      <p class="eyebrow">Facturación Electrónica</p>
      <h2>Gestión de Facturas</h2>
      <p class="subtitle">Controla tus comprobantes y elige ambiente SRI: Pruebas o Producción</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline" type="button">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Exportar
      </button>
      <button class="btn btn-primary" type="button" (click)="nuevaFactura()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
        Nueva Factura
      </button>
    </div>
  </header>

  <!-- Métricas -->
  <div class="metrics-row">
    <div class="metric-card success">
      <div class="metric-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
      </div>
      <div class="metric-content">
        <p class="metric-label">Facturas Autorizadas</p>
        <h3 class="metric-value">{{ facturasAutorizadas() }}</h3>
      </div>
    </div>

    <div class="metric-card warning">
      <div class="metric-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      </div>
      <div class="metric-content">
        <p class="metric-label">Pendientes de Envío</p>
        <h3 class="metric-value">{{ facturasPendientes() }}</h3>
      </div>
    </div>

    <div class="metric-card primary">
      <div class="metric-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      </div>
      <div class="metric-content">
        <p class="metric-label">Total Facturado</p>
        <h3 class="metric-value">{{ totalFacturado() | currency:'USD':'symbol':'1.2-2' }}</h3>
      </div>
    </div>

    <div class="metric-card info">
      <div class="metric-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h16"/><path d="M4 12h16"/><path d="M4 17h16"/></svg>
      </div>
      <div class="metric-content">
        <p class="metric-label">Ambiente SRI</p>
        <h3 class="metric-value">{{ facturasPruebas() }} P / {{ facturasProduccion() }} PRD</h3>
      </div>
    </div>
  </div>

  <!-- Tabla de facturas -->
  <div class="card facturas-table">
    <div class="table-header">
      <h3>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        Facturas Emitidas
      </h3>
      <div class="table-filters">
        <select class="input-sm" [value]="statusFilter()" (change)="statusFilter.set($any($event.target).value)">
          <option value="">Todos los estados</option>
          <option value="Authorized">Autorizadas</option>
          <option value="Pending">Pendientes</option>
          <option value="Rejected">Rechazadas</option>
        </select>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Número</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Subtotal</th>
            <th>IVA</th>
            <th>Total</th>
            <th>Forma Pago</th>
            <th>Ambiente</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let factura of filteredFacturas()">
            <td class="font-mono">{{ factura.number }}</td>
            <td>{{ factura.issuedAt | date:'dd/MM/yyyy' }}</td>
            <td>
              <div class="cliente-cell">
                <strong>{{ factura.customer.name }}</strong>
                <span class="text-muted">{{ factura.customer.identification }}</span>
              </div>
            </td>
            <td>{{ factura.subtotal | currency:'USD':'symbol':'1.2-2' }}</td>
            <td>{{ factura.tax | currency:'USD':'symbol':'1.2-2' }}</td>
            <td><strong>{{ factura.totalToCharge | currency:'USD':'symbol':'1.2-2' }}</strong></td>
            <td>
              <span class="badge badge-payment">{{ formatPayment(factura.paymentMethod) }}</span>
            </td>
            <td>
              <span class="badge badge-environment" [attr.data-environment]="factura.sriEnvironment">
                {{ formatSriEnvironment(factura.sriEnvironment) }}
              </span>
            </td>
            <td>
              <span class="badge" [attr.data-status]="factura.status">
                {{ formatStatus(factura.status) }}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn-icon" type="button" (click)="verDetalle(factura.id)" title="Ver detalle">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
                <button class="btn-icon" type="button" (click)="descargarPDF(factura.id)" title="Descargar PDF">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </button>
                <button class="btn-icon" type="button" *ngIf="factura.status === 'Pending'" (click)="reenviarSRI(factura.id)" title="Enviar al SRI">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
