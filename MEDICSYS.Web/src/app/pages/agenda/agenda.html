<app-top-nav></app-top-nav>

<section class="page agenda-page">
  <header class="page-header">
    <div>
      <p class="eyebrow">Agenda m√©dica</p>
      <h2>Calendario de citas</h2>
      <p class="subtitle">Consulta horarios disponibles y agenda citas con pacientes.</p>
    </div>
  </header>

  <div class="agenda-toolbar">
    <div class="toolbar-group">
      <button class="btn btn-ghost" type="button" (click)="previousMonth()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        Mes anterior
      </button>
      <button class="btn btn-ghost" type="button" (click)="nextMonth()">
        Mes siguiente
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>
    <div class="toolbar-group">
      <label class="field">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Profesor
        <select class="input" [value]="selectedProfessorId()" (change)="setProfessor($any($event.target).value)">
          <option *ngFor="let prof of professors()" [value]="prof.id">{{ prof.fullName }}</option>
        </select>
      </label>
      <label class="field" *ngIf="isProfessor()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Alumno
        <select class="input" [value]="selectedStudentId()" (change)="setStudent($any($event.target).value)">
          <option *ngFor="let student of students()" [value]="student.id">{{ student.fullName }}</option>
        </select>
      </label>
    </div>
  </div>

  <div class="agenda-grid">
    <div class="calendar card">
      <div class="calendar-header">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        <h3>{{ selectedDate() | date:'MMMM yyyy' }}</h3>
      </div>
      <div class="calendar-weekdays">
        <span>Dom</span><span>Lun</span><span>Mar</span><span>Mie</span><span>Jue</span><span>Vie</span><span>Sab</span>
      </div>
      <div class="calendar-days">
        <button
          class="day"
          *ngFor="let day of calendarDays()"
          [class.is-empty]="!day.date"
          [class.is-today]="day.isToday"
          (click)="selectDay(day)">
          {{ day.label }}
        </button>
      </div>
    </div>

    <div class="availability card">
      <h3>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Horarios disponibles
      </h3>
      <div class="availability-panels">
        <div class="panel">
          <h4>Profesor</h4>
          <div class="slots">
            <button
              class="slot"
              *ngFor="let slot of professorAvailability()?.slots"
              [class.occupied]="!slot.isAvailable"
              [disabled]="!slot.isAvailable || creating()"
              (click)="book(slot)">
              {{ slot.startAt | date:'shortTime' }}
            </button>
          </div>
        </div>
        <div class="panel">
          <h4>Alumno</h4>
          <div class="slots">
            <span
              class="slot status"
              *ngFor="let slot of studentAvailability()?.slots"
              [class.occupied]="!slot.isAvailable">
              {{ slot.startAt | date:'shortTime' }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card appointments">
    <div class="list-header">
      <h3>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4M16 2v4M3 10h18"/><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/></svg>
        Citas programadas
      </h3>
    </div>
    <div *ngIf="appointments().length === 0" class="empty">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      <p>No hay citas registradas.</p>
    </div>
    <div class="appointment-list" *ngIf="appointments().length > 0">
      <article class="appointment" *ngFor="let appt of appointments()">
        <div class="appointment-info">
          <h4>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            {{ appt.patientName }}
          </h4>
          <p>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            {{ appt.startAt | date:'medium' }} - {{ appt.endAt | date:'shortTime' }}
          </p>
          <p class="meta">Profesor: {{ appt.professorName }} | Alumno: {{ appt.studentName }}</p>
        </div>
        <div class="appointment-actions">
          <button class="btn btn-outline" type="button" (click)="openGoogleCalendar(appt)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            Google Calendar
          </button>
          <button class="btn btn-outline" type="button" (click)="openOutlookEmail(appt)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="m3 7 9 6 9-6"/></svg>
            Email
          </button>
          <button class="btn btn-ghost" type="button" (click)="openWhatsApp(appt)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            WhatsApp
          </button>
        </div>
      </article>
    </div>
  </div>

  <div class="card reminders" *ngIf="reminders().length > 0">
    <div class="list-header">
      <h3>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
        Recordatorios pendientes
      </h3>
    </div>
    <div class="appointment-list">
      <article class="appointment" *ngFor="let reminder of reminders()">
        <div>
          <h4>{{ reminder.channel }}</h4>
          <p>{{ reminder.message }}</p>
          <p class="meta">Programado: {{ reminder.scheduledAt | date:'medium' }}</p>
        </div>
        <div class="appointment-actions">
          <button class="btn btn-outline" type="button" *ngIf="reminder.channel === 'Email'" (click)="openOutlookEmail({ id: '', studentId: '', studentName: reminder.target, studentEmail: reminder.target, professorId: '', professorName: '', professorEmail: '', patientName: reminder.target, reason: reminder.message, startAt: reminder.scheduledAt, endAt: reminder.scheduledAt, status: '', notes: null })">Email</button>
          <button class="btn btn-ghost" type="button" *ngIf="reminder.channel === 'WhatsApp'" (click)="openWhatsApp({ id: '', studentId: '', studentName: reminder.target, studentEmail: '', professorId: '', professorName: '', professorEmail: '', patientName: reminder.target, reason: reminder.message, startAt: reminder.scheduledAt, endAt: reminder.scheduledAt, status: '', notes: null })">WhatsApp</button>
        </div>
      </article>
    </div>
  </div>
</section>
