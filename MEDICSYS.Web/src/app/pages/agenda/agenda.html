<app-top-nav></app-top-nav>

<section class="modern-agenda-page">
  <!-- Header moderno -->
  <header class="modern-header">
    <div class="header-content">
      <div class="title-section">
        <h1>ğŸ“… Agenda MÃ©dica</h1>
        <p>Gestiona tus citas y horarios disponibles</p>
      </div>
      <div class="header-actions">
        <div class="date-badge">
          {{ selectedDate() | date:'EEEE, d MMMM yyyy' }}
        </div>
      </div>
    </div>
  </header>

  <!-- Filtros modernos -->
  <div class="filters-card">
    <div class="filters-grid">
      <div class="filter-item">
        <label>
          <span class="filter-label">{{ isOdontologo() ? 'ğŸ¦· OdontÃ³logo' : 'ğŸ‘¨â€ğŸ« Profesor' }}</span>
          <select class="modern-select" [disabled]="isProvider()" [value]="selectedProfessorId()" (change)="setProfessor($any($event.target).value)">
            <option value="">Seleccionar...</option>
            <option *ngFor="let prof of professors()" [value]="prof.id">{{ prof.fullName }}</option>
          </select>
        </label>
      </div>

      <div class="filter-item">
        <label>
          <span class="filter-label">ğŸ“‹ Motivo de consulta</span>
          <input
            class="modern-input"
            type="text"
            [value]="appointmentReason()"
            (input)="appointmentReason.set($any($event.target).value)"
            placeholder="Ej: Consulta general, Limpieza..."
          />
        </label>
      </div>
    </div>
  </div>

  <!-- Grid principal -->
  <div class="agenda-modern-grid">
    <!-- Calendario mejorado -->
    <div class="calendar-modern-card">
      <div class="calendar-modern-header">
        <button class="nav-btn" (click)="previousMonth()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
        </button>
        <h2>{{ selectedDate() | date:'MMMM yyyy' }}</h2>
        <button class="nav-btn" (click)="nextMonth()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"/>
          </svg>
        </button>
      </div>

      <div class="calendar-weekdays">
        <span>Dom</span><span>Lun</span><span>Mar</span><span>MiÃ©</span><span>Jue</span><span>Vie</span><span>SÃ¡b</span>
      </div>

      <div class="calendar-days-grid">
        <button
          *ngFor="let day of calendarDays()"
          class="calendar-day"
          [class.empty]="!day.date"
          [class.today]="day.isToday"
          [class.selected]="day.date && day.date.toDateString() === selectedDate().toDateString()"
          (click)="selectDay(day)"
          (dblclick)="onDayDoubleClick(day)"
          title="Doble click para crear cita"
        >
          <span class="day-number">{{ day.label }}</span>
          <span class="day-indicator" *ngIf="day.date && getAppointmentsForDate(day.date).length > 0">
            {{ getAppointmentsForDate(day.date).length }}
          </span>
        </button>
      </div>
    </div>

    <!-- Horarios disponibles modernos -->
    <div class="availability-modern-card">
      <h3>â° Horarios Disponibles</h3>
      <div class="availability-content">
        <div class="availability-panel">
          <h4>{{ isOdontologo() ? 'OdontÃ³logo' : 'Profesor' }}</h4>
          <div class="slots-grid">
            <button
              *ngFor="let slot of professorAvailability()?.slots"
              class="time-slot"
              [class.occupied]="!slot.isAvailable"
              [class.available]="slot.isAvailable"
              [disabled]="!slot.isAvailable || creating()"
              (click)="book(slot)"
            >
              <span class="slot-time">{{ slot.startAt | date:'shortTime' }}</span>
              <span class="slot-status">{{ slot.isAvailable ? 'Disponible' : 'Ocupado' }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Citas del dÃ­a seleccionado -->
  <div class="appointments-modern-card" *ngIf="appointmentsForSelectedDate().length > 0">
    <h3>ğŸ“‹ Citas para {{ selectedDate() | date:'d MMMM yyyy' }}</h3>
    <div class="appointments-modern-list">
      <div *ngFor="let appt of appointmentsForSelectedDate()" class="appointment-modern-item" (click)="onAppointmentClick(appt)" style="cursor: pointer;">
        <div class="appointment-modern-time">
          <div class="time-badge">
            {{ appt.startAt | date:'shortTime' }}
          </div>
          <div class="duration">
            {{ calculateDuration(appt) }} min
          </div>
        </div>

        <div class="appointment-modern-content">
          <div class="appointment-modern-header">
            <h4>{{ appt.patientName }}</h4>
            <span class="status-badge confirmed">Confirmada</span>
          </div>
          <p class="appointment-modern-reason">{{ appt.reason }}</p>
          <div class="appointment-modern-meta">
            <span>ğŸ‘¨â€âš•ï¸ {{ appt.professorName }}</span>
            <span>â€¢</span>
            <span>ğŸ“ {{ appt.studentName }}</span>
          </div>
        </div>

        <div class="appointment-modern-actions" (click)="$event.stopPropagation()">
          <button class="btn-modern btn-edit" (click)="onAppointmentClick(appt)" title="Editar cita">
            âœï¸
          </button>
          <button class="btn-modern btn-calendar" (click)="openGoogleCalendar(appt)" title="Google Calendar">
            ğŸ“…
          </button>
          <button class="btn-modern btn-email" (click)="openOutlookEmail(appt)" title="Enviar email">
            ğŸ“§
          </button>
          <button class="btn-modern btn-whatsapp" (click)="openWhatsApp(appt)" title="WhatsApp">
            ğŸ’¬
          </button>
          <button class="btn-modern btn-delete" (click)="deleteAppointment(appt)" title="Eliminar cita">
            ğŸ—‘ï¸
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Todas las citas programadas -->
  <div class="all-appointments-card">
    <h3>ğŸ“… Todas las Citas Programadas</h3>
    <div class="appointments-timeline" *ngIf="appointments().length > 0">
      <div *ngFor="let appt of appointments()" class="timeline-item" (click)="onAppointmentClick(appt)" style="cursor: pointer;">
        <div class="timeline-marker"></div>
        <div class="timeline-content">
          <div class="timeline-header">
            <h4>{{ appt.patientName }}</h4>
            <span class="timeline-date">{{ appt.startAt | date:'medium' }}</span>
          </div>
          <p>{{ appt.reason }}</p>
          <div class="timeline-meta">
            <span>ğŸ‘¨â€âš•ï¸ {{ appt.professorName }}</span>
            <span>â€¢</span>
            <span>{{ isOdontologo() ? 'ğŸ‘¤' : 'ğŸ“' }} {{ appt.studentName }}</span>
          </div>
        </div>
        <div class="timeline-actions">
          <button class="btn-mini" (click)="onAppointmentClick(appt); $event.stopPropagation()" title="Editar">âœï¸</button>
          <button class="btn-mini" (click)="deleteAppointment(appt); $event.stopPropagation()" title="Eliminar">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>
    <div class="empty-state" *ngIf="appointments().length === 0">
      <div class="empty-icon">ğŸ“­</div>
      <h4>No hay citas programadas</h4>
      <p>Las citas agendadas aparecerÃ¡n aquÃ­</p>
    </div>
  </div>
</section>

<!-- Modal de Cita -->
<app-appointment-modal
  *ngIf="modalData()"
  [data]="modalData()"
  [isProvider]="isProvider()"
  [currentUserId]="currentUserId()"
  [role]="role()"
  (close)="closeModal()"
  (save)="saveAppointmentFromModal($event)"
  (delete)="deleteAppointmentFromModal($event)">
</app-appointment-modal>
